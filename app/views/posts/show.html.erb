<% share_image = @post.image.attached? ? rails_blob_url(@post.image, host: request.base_url) : image_url('default.png') %>
<% set_meta_tags og: {
    title: "#{@user.username}@Quester",
    description: "#{@user.username}さんの質問です。「#{@post.content}」",
    image: share_image
 } %>

<%= image_tag(@post.image, class: "img-fluid shadow-lg rounded-4 post-image", loading: "lazy") if @post.image.attached? %>

<% is_owner = current_user == @user %>
<% show_profile_fallback = !@post.image.attached? %>

<% unless is_owner %>
  <% if show_profile_fallback %>
    <div class="toppage-profile card my-5">
      <div class="card-body">
        <div class="media p-3 border rounded">
          <%= link_to image_tag(avatar_url(@user), size: "80x80", class: "rounded-circle mr-3", loading: "lazy"),
              user_path(@user) %>
          <div class="media-body">
            <div class="d-flex align-items-center justify-content-between">
              <h5 class="mb-1"><%= @user.username %></h5>
              <%= link_to @user.url, target: "_blank", rel: "noopener", class: "text-muted" do %>
                <i class="fab fa-twitter"></i>
              <% end %>
            </div>
            <p><%= simple_format(h(@post.content)) %></p>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  <div class="d-flex justify-content-end mb-3">
    <%= link_to "#{@user.username}さんのページへ", user_path(@user), class: "btn btn-ghost post-author-link mb-0" %>
  </div>

  <div class="reply">
    <div class="text-center">
      <h1>回答する</h1>
      <p><%= @user.username %>さんの質問に回答します。回答は匿名で送られます。</p>
    </div>
    <div class="form-group card">
      <% if @post.status %>
        <%= render 'replies/form', reply: @reply, post: @post %>
      <% else %>
        <div class="card-body text-center">
          この質問への回答は締め切られました。
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<% if @user == current_user %>
  <div class="change text-center my-4">
    <%= render 'posts/edit_form', user: @user, post: @post %>
  </div>
  <div class="other-replies my-5">
    <div class="text-center">
      <h1>回答一覧</h1>
      <p>この質問に送られてきた回答の一覧です。回答は他の人には見えません。</p>
    </div>
    <%= render 'replies/replies', replies: @replies %>
  </div>
<% end %>
